<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
  <style type="text/css">
    #map-canvas {
      width: 800px;
      height: 600px;
    }

    .float-left {
      float: left;
      margin-right: 10px;
    }
  </style>
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script type="text/javascript"
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxTEbJsXwGRW4zDj8fpVsenDMMQGhZhUU&sensor=false&libraries=geometry">
  </script>
  <script data-main="../initialize" src="../../externals/require.js"></script>
  <script type="text/javascript">
    function randomFloatBetween(minValue, maxValue, precision) {
      precision = precision == undefined ? 2 : precision;
      return parseFloat(Math.min(minValue + (Math.random() * (maxValue - minValue)), maxValue).toFixed(precision));
    }

    function getRandomLatLon(from, to) {
      var center = [44.98, -93.2636];
      var radius = 0.125;
      from || (from = [center[0] - radius, center[1] - radius]);
      to || (to = [center[0] + radius, center[1] + radius]);

      return [
        this.randomFloatBetween(from[0], to[0], 5),
        this.randomFloatBetween(from[1], to[1], 5)
      ];
    }


    function initialize() {
      require.setStrategy('gmaps');
      require([
        'base/map',
        'aeris/util',
        'aeris/config',
        'gmaps/route/routebuilder',
        'gmaps/route/waypoint'
      ], function(Map, _, config, RouteBuilder, Waypoint) {
        var map = new Map('map-canvas');
        var routeBuilder = new RouteBuilder({
          styles: {
            waypoint: {
              url: config.get('path') + 'assets/marker_green.png'
            },
            selectedWaypoint: {
              url: config.get('path') + 'assets/poi.png'
            },
            path: {
              strokeColor: 'blue',
              strokeWeight: 3,
              strokeOpacity: 0.85
            },
            offPath: {
              strokeColor: 'red',
              strokeWeight: 5,
              strokeOpacity: 0.95
            }
          }
        });
        var route = routeBuilder.getRoute();

        routeBuilder.setMap(map);

        map.on('click', function(latLon) {
          var waypoint = waypointFromLatLon(latLon);
          routeBuilder.addWaypoint(waypoint);
        });


        routeBuilder.on('waypoint:click', function(latLon, waypoint) {
          waypoint.toggleSelect();
        });


        routeBuilder.on('command', updateCommandBtnState);

        route.on('directions:request', showLoading);
        route.on('directions:complete', hideLoading);
        route.on('directions:error', handleDirectionsError);


        $('#clearSelected').on('click', function() {
          var selected = route.getSelected();

          _.each(selected, function(waypoint) {
            routeBuilder.removeWaypoint(waypoint);
          });
        });


        $('#clearAll').on('click', function() {
          routeBuilder.resetRoute();
        });

        $('#travelMode').on('change', function() {
          var mode = $(this).val();
          routeBuilder.travelMode = mode;
        });

        $('#followDirections').on('change', function() {
          var followDirections = $(this).prop('checked');
          routeBuilder.followDirections = followDirections;
        });

        $('#exportRoute').on('click', function() {
          $('#routeDisplay').val(route.export());
        });

        $('#importRoute').on('click', function() {
          var dataString = $('#routeDisplay').val();
          route.import(dataString);
        });


        function waypointFromLatLon(latLon) {
          return new Waypoint({
            position: latLon
          });
        }

        function updateCommandBtnState() {
          $('#undo').prop('disabled', routeBuilder.canUndo());
          $('#redo').prop('disabled', routeBuilder.canRedo());
        }

        function showLoading() {
          $('#loading').show();
        }
        function hideLoading() {
          $('#loading').hide();
        }

        function handleDirectionsError(waypoint, errorResponse) {
          console.warn(errorResponse);
        }
      });


    }
  </script>
</head>
<body>
<div class="float-left">
  <div>
    <strong>Total distance:</strong>
    <span id="total-distance">0</span> miles
  </div>
  <div id="map-canvas"></div>
  <div class="float-left">

    <div>
      <button id="undo">Undo</button>
      <button id="redo">Redo</button>
    </div>

    <div>
      <button id="clearSelected">Clear selected</button>
      <button id="clearAll">Clear All</button>
    </div>

    <div>
      <input type="checkbox" checked="checked" id="followDirections">
      <label for="followDirections">Follow Directions?</label>
    </div>

    <div>
      <strong>JSON Route Mapper</strong>
      <button id="exportRoute">Export</button>
      <button id="importRoute">Import</button>
      <br/>
      <textarea id="routeDisplay" cols="80" rows="12"></textarea>
    </div>
  </div>

  <h3 id="loading" style="display:none">Loading...</h3>
</div>
</body>
</html>
